<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„ØµÙˆØª" />
<meta name="theme-color" content="#008cff" />
<title>ØªØ¬Ø±Ø¨Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙˆØª</title>

<!-- PWA Links -->
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/icon-192.png">
<link rel="apple-touch-icon" href="/icon-192.png">

<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    padding: 15px;
    background: #f5f5f5;
    min-height: 100vh;
  }
  h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #333;
  }
  .box {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  input, select, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 16px;
    font-family: inherit;
  }
  button {
    background: #008cff;
    color: white;
    font-weight: bold;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:active {
    background: #0070d9;
  }
  .box h3 {
    margin-bottom: 10px;
    color: #555;
  }
  #installPrompt {
    display: none;
    background: #4CAF50;
    color: white;
    padding: 12px;
    text-align: center;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  #installPrompt button {
    background: white;
    color: #4CAF50;
    padding: 8px 20px;
    margin-top: 8px;
    width: auto;
  }
</style>
</head>
<body>

<div id="installPrompt">
  <p>ğŸ“± ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ!</p>
  <button id="installBtn">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
</div>

<h2>ğŸ¤ ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„ØµÙˆØª</h2>

<div class="box">
  <button id="recordBtn">ğŸ¤ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
  <input type="text" id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
  <input type="number" id="productPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±" />
  <button id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
</div>

<div class="box">
  <button id="searchVoiceBtn">ğŸ” Ø¨Ø­Ø« ØµÙˆØªÙŠ</button>
  <input type="text" id="searchName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¨Ø­Ø«" />
  <button id="searchBtn">Ø¨Ø­Ø«</button>
</div>

<div class="box">
  <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</h3>
  <select id="productsDropdown" size="5"></select>
</div>

<script>
// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => {
        console.log('âœ… Service Worker registered:', reg);
      })
      .catch(err => {
        console.error('âŒ Service Worker registration failed:', err);
      });
  });
}

// PWA Install Prompt
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installPrompt').style.display = 'block';
});

document.getElementById('installBtn').addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`User response: ${outcome}`);
    deferredPrompt = null;
    document.getElementById('installPrompt').style.display = 'none';
  }
});

window.addEventListener('appinstalled', () => {
  console.log('âœ… PWA installed successfully');
  document.getElementById('installPrompt').style.display = 'none';
});

// App Logic
let products = JSON.parse(localStorage.getItem("prodDB") || "{}");
refreshDropdown();

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
  alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª");
}

let recognizer = SpeechRecognition ? new SpeechRecognition() : null;
if (recognizer) {
  recognizer.lang = "ar-SA";
  recognizer.interimResults = false;
}

document.getElementById('recordBtn').onclick = () => {
  if (!recognizer) return alert("Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
  
  recognizer.start();
  recognizer.onresult = (e) => {
    let text = e.results[0][0].transcript;

    if (!isNaN(parseFloat(text))) {
      document.getElementById("productPrice").value = text;
    } else {
      document.getElementById("productName").value = text;
    }
  };
  
  recognizer.onerror = (e) => {
    console.error("Speech recognition error:", e.error);
  };
};

document.getElementById('saveBtn').onclick = () => {
  let name = productName.value.trim();
  let price = productPrice.value.trim();
  if (!name || !price) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");

  products[name] = price;
  localStorage.setItem("prodDB", JSON.stringify(products));
  refreshDropdown();
  alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
  
  productName.value = '';
  productPrice.value = '';
};

document.getElementById('searchVoiceBtn').onclick = () => {
  if (!recognizer) return alert("Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
  
  recognizer.start();
  recognizer.onresult = (e) => {
    document.getElementById('searchName').value = e.results[0][0].transcript;
  };
};

document.getElementById('searchBtn').onclick = () => {
  let name = searchName.value.trim();
  if (products[name]) {
    productName.value = name;
    productPrice.value = products[name];
    alert("âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„");
  } else {
    alert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  }
};

function refreshDropdown() {
  let drop = document.getElementById("productsDropdown");
  drop.innerHTML = "";
  
  if (Object.keys(products).length === 0) {
    let option = document.createElement("option");
    option.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©";
    option.disabled = true;
    drop.appendChild(option);
    return;
  }
  
  for (let name in products) {
    let option = document.createElement("option");
    option.textContent = `${name} - ${products[name]} Ø±.Ø³`;
    drop.appendChild(option);
  }
}
</script>

</body>
</html>
